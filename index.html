<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作業一覧2026</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' },
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        accent: { 500: '#10b981', 600: '#059669' } 
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 0 0 1px rgba(0,0,0,0.03), 0 2px 8px rgba(0,0,0,0.04)',
                        'floating': '0 10px 40px -10px rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-spin-slow { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #error-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; padding: 20px; color: red; overflow: auto; }
        @keyframes slideInRight { 0% { opacity: 0; transform: translateX(30px); } 100% { opacity: 1; transform: translateX(0); } }
        @keyframes fadeInLeft { 0% { opacity: 0; transform: translateX(-30px); } 100% { opacity: 1; transform: translateX(0); } }
        .animate-slide-in-right { animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-fade-in-left { animation: fadeInLeft 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes expandFadeIn { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } }
        .animate-expand-fade-in { animation: expandFadeIn 0.3s ease-out forwards; }
        @keyframes slideUpFade { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        .animate-slide-up-fade { animation: slideUpFade 0.3s ease-out forwards; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="error-overlay"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const overlay = document.getElementById('error-overlay');
            overlay.style.display = 'block';
            overlay.innerHTML += `<h3>Error Occurred</h3><p>${message}</p><p>${source}:${lineno}:${colno}</p><pre>${error && error.stack}</pre>`;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const isPreview = typeof google === 'undefined' || typeof google.script === 'undefined';
        let mockProjects = [];

        const backend = {
            getData: (onSuccess, onFailure) => {
                if (isPreview) { setTimeout(() => onSuccess({ projects: mockProjects }), 500); }
                else { google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).apiGetData(); }
            },
            syncWbsProgress: (onSuccess, onFailure) => {
                if (isPreview) {
                    mockProjects = mockProjects.map(p => ({ ...p, wbsProgress: Math.random() })); 
                    setTimeout(() => onSuccess({ projects: [...mockProjects] }), 1000);
                } else { google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).apiSyncWbsProgress(); }
            },
            heartbeat: (onSuccess, onFailure) => {
                if (isPreview) {
                    const users = ["自分", "金丸", "三輪"].filter(() => Math.random() > 0.3);
                    if(!users.includes("自分")) users.push("自分");
                    setTimeout(() => onSuccess({ activeUsers: users }), 500);
                } else { google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).apiHeartbeat(); }
            },
            // ★見積ファイル検索APIラッパー
            getFileUrlByEstimateNo: (estimateNo, onSuccess, onFailure) => {
                if (isPreview) { setTimeout(() => onSuccess("https://example.com/mock-file.pdf"), 1000); }
                else { google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).apiGetFileUrlByEstimateNo(estimateNo); }
            },
            createProject: (project, onSuccess, onFailure) => {
                if (isPreview) {
                    if(!project.id) project.id = Math.random().toString(36).substr(2, 9);
                    mockProjects.push(project);
                    setTimeout(() => onSuccess({ projects: [...mockProjects] }), 1500);
                } else { google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).apiCreateProject(project); }
            },
            updateProject: (project, onSuccess, onFailure) => {
                if (isPreview) {
                    const idx = mockProjects.findIndex(p => p.id === project.id);
                    if(idx >= 0) mockProjects[idx] = project;
                    setTimeout(() => onSuccess({ projects: [...mockProjects] }), 500);
                } else { google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).apiUpdateProject(project); }
            },
            deleteProject: (projectId, onSuccess, onFailure) => {
                if (isPreview) {
                    const idx = mockProjects.findIndex(p => p.id === projectId);
                    if(idx >= 0) mockProjects.splice(idx, 1);
                    setTimeout(() => onSuccess({ projects: [...mockProjects] }), 500);
                } else { google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).apiDeleteProject(projectId); }
            },
            addMemo: (projectId, text, onSuccess, onFailure) => {
                if (isPreview) {
                    const idx = mockProjects.findIndex(p => p.id === projectId);
                    if(idx >= 0) {
                         const now = new Date();
                         const timeStr = now.getFullYear() + "/" + ("0"+(now.getMonth()+1)).slice(-2) + "/" + ("0"+now.getDate()).slice(-2) + " " + ("0"+now.getHours()).slice(-2) + ":" + ("0"+now.getMinutes()).slice(-2);
                         const newEntry = `[${timeStr} demo]\n${text}`;
                         mockProjects[idx].description = newEntry + "\n\n" + (mockProjects[idx].description || "");
                    }
                    setTimeout(() => onSuccess({ projects: [...mockProjects] }), 500);
                } else { google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).apiAddMemo(projectId, text); }
            },
            editMemo: (projectId, oldRaw, newText, onSuccess, onFailure) => {
                if (isPreview) { setTimeout(() => onSuccess({ projects: [...mockProjects] }), 500); }
                else { google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).apiEditMemo(projectId, oldRaw, newText); }
            },
            deleteMemo: (projectId, entryContent, onSuccess, onFailure) => {
                if (isPreview) { setTimeout(() => onSuccess({ projects: [...mockProjects] }), 500); }
                else { google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).apiDeleteMemo(projectId, entryContent); }
            }
        };

        const IconBase = ({ children, className, style }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>{children}</svg>);
        const PlusIcon = ({ className }) => (<IconBase className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>);
        const BriefcaseIcon = ({ className }) => (<IconBase className={className}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></IconBase>);
        const ArchiveIcon = ({ className }) => (<IconBase className={className}><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></IconBase>);
        const ChevronDownIcon = ({ className }) => (<IconBase className={className}><polyline points="6 9 12 15 18 9"></polyline></IconBase>);
        const ChevronUpIcon = ({ className }) => (<IconBase className={className}><polyline points="18 15 12 9 6 15"></polyline></IconBase>);
        const MapPinIcon = ({ className }) => (<IconBase className={className}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></IconBase>);
        const FileTextIcon = ({ className }) => (<IconBase className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></IconBase>);
        const ExternalLinkIcon = ({ className }) => (<IconBase className={className}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></IconBase>);
        const RefreshIcon = ({ className }) => (<IconBase className={className}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path><path d="M16 21h5v-5"></path></IconBase>);
        const CheckCircleIcon = ({ className }) => (<IconBase className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>);
        const XIcon = ({ className }) => (<IconBase className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>);
        const UserIcon = ({ className }) => (<IconBase className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></IconBase>);
        const SettingsIcon = ({ className }) => (<IconBase className={className}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></IconBase>);
        const SendIcon = ({ className }) => (<IconBase className={className}><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></IconBase>);
        const TrashIcon = ({ className }) => (<IconBase className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></IconBase>);
        const PencilIcon = ({ className }) => (<IconBase className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></IconBase>);
        const SaveIcon = ({ className }) => (<IconBase className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconBase>);
        const ChevronLeftIcon = ({ className, style }) => (<IconBase className={className} style={style}><polyline points="15 18 9 12 15 6"></polyline></IconBase>);
        const ChevronRightIcon = ({ className, style }) => (<IconBase className={className} style={style}><polyline points="9 18 15 12 9 6"></polyline></IconBase>);
        const CalendarIcon = ({ className }) => (<IconBase className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></IconBase>);
        const RotateCcwIcon = ({ className }) => (<IconBase className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></IconBase>);

        const PROJECT_STATUS_OPTIONS = [
            "作業開始前","資料受領待ち", "成果物作成中", "社内レビュー待ち", "ムラシスレビュー待ち",
            "統合試験準備中", "統合試験中", "社内検証準備中", "社内検証中",
            "システム検証待ち", "システム検証中", "第三者検証待ち", "第三者検証中",
            "完了", "作業保留中", "VAO/MCS試験待ち", "VAO/MCS試験中", "出張中", "請求済"
        ];
        const MEMBER_OPTIONS = ["金丸", "三輪", "大﨑", "齋藤"];
        const TARGET_TASKS = [
          { key: 'revInternal', name: '定義レビュー(社内)', shortName: '社内レビュー' },
          { key: 'revMurasys',  name: '定義レビュー(ムラシス)', shortName: 'ムラシスレビュー' },
          { key: 'testInteg',   name: '統合試験', shortName: '統合試験' },
          { key: 'testActs',    name: 'ACTS社内検証', shortName: 'ACTS検証' },
          { key: 'testSystem',  name: 'システム検証', shortName: 'システム検証' },
          { key: 'test3rd',     name: '第三者検証', shortName: '第三者検証' }
        ];

        const getRowHeight = (project) => {
            let members = [];
            try { members = JSON.parse(project.memberSchedules || '[]'); } catch(e){}
            const memberCount = Math.max(members.length, 1);
            return Math.max(180, (memberCount * 32) + 40);
        };

        const formatProgress = (val) => {
            if (val === undefined || val === '' || val === null) return '0%';
            if (typeof val === 'number') return Math.round(val * 100) + '%';
            if (typeof val === 'string') {
                if (val.includes('%')) return val;
                const num = parseFloat(val);
                if (!isNaN(num)) {
                    if (num <= 1 && num > 0) return Math.round(num * 100) + '%';
                    return Math.round(num) + '%';
                }
            }
            return val;
        };
        const formatCost = (val, decimals) => {
            if (val === undefined || val === '' || val === null) return '-';
            const num = parseFloat(val);
            if (isNaN(num)) return val;
            return num.toFixed(decimals);
        };
        const formatDateShort = (dateStr) => {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            return `${date.getMonth() + 1}/${date.getDate()}`;
        };
        // フォーム用の日付フォーマッター（ISO -> YYYY-MM-DD）
        const formatDateForInput = (isoString) => {
            if (!isoString) return '';
            try {
                return new Date(isoString).toISOString().split('T')[0];
            } catch (e) { return ''; }
        };
        const createLocalDate = (dateStr) => {
            if (!dateStr) return null;
            if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const [y, m, d] = dateStr.split('-').map(Number);
                return new Date(y, m - 1, d);
            }
            const d = new Date(dateStr);
            return new Date(d.getFullYear(), d.getMonth(), d.getDate());
        };

        const MultiSelect = ({ label, options, value, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const selectedValues = value ? value.split(',').map(s => s.trim()).filter(Boolean) : [];
            const toggleOption = (option) => {
                let newValues = selectedValues.includes(option) ? selectedValues.filter(v => v !== option) : [...selectedValues, option];
                const sorted = options.filter(o => newValues.includes(o));
                onChange(sorted.join(', '));
            };
            return (
                <div className="relative group">
                    <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">{label}</label>
                    <button onClick={(e) => { e.stopPropagation(); setIsOpen(!isOpen); }} className={`w-full text-left text-xs font-bold bg-slate-50 border border-slate-200 rounded px-2 py-1.5 focus:outline-none flex justify-between items-center min-h-[28px] ${isOpen ? 'ring-1 ring-brand-500 border-brand-500' : ''}`}>
                        <span className="flex-1 leading-tight break-words">{selectedValues.length > 0 ? selectedValues.join(', ') : <span className="text-slate-400">未選択</span>}</span>
                        <ChevronDownIcon className={`w-3 h-3 text-slate-500 ml-1 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                    </button>
                    {isOpen && (
                        <div className="w-full bg-white border border-slate-200 rounded-md shadow-sm mt-1 overflow-hidden z-10 relative">
                            {options.map(opt => (
                                <div key={opt} className="flex items-center px-2 py-1.5 hover:bg-slate-50 cursor-pointer border-b border-slate-50 last:border-0" onClick={(e) => { e.stopPropagation(); toggleOption(opt); }}>
                                    <div className={`w-3 h-3 border rounded mr-2 flex items-center justify-center ${selectedValues.includes(opt) ? 'bg-brand-500 border-brand-500' : 'border-slate-300'}`}>
                                        {selectedValues.includes(opt) && <svg className="w-2.5 h-2.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"></polyline></svg>}
                                    </div>
                                    <span className="text-xs text-slate-700">{opt}</span>
                                </div>
                            ))}
                        </div>
                    )}
                    {isOpen && <div className="fixed inset-0 z-0" onClick={() => setIsOpen(false)}></div>}
                </div>
            );
        };

        function ToastContainer({ toasts, removeToast }) {
            return (
                <div className="fixed bottom-4 right-4 z-[9999] flex flex-col gap-2 pointer-events-none">
                    {toasts.map(toast => (
                        <div key={toast.id} className={`pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg shadow-floating animate-slide-up-fade border ${toast.type === 'loading' ? 'bg-white border-brand-200 text-slate-700' : toast.type === 'success' ? 'bg-emerald-50 border-emerald-200 text-emerald-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                            {toast.type === 'loading' && <RefreshIcon className="w-4 h-4 animate-spin text-brand-500" />}
                            {toast.type === 'success' && <CheckCircleIcon className="w-4 h-4 text-emerald-600" />}
                            {toast.type === 'error' && <XIcon className="w-4 h-4 text-red-600" />}
                            <span className="text-sm font-bold">{toast.message}</span>
                        </div>
                    ))}
                </div>
            );
        }

        function ActiveUserIndicator({ activeUsers }) {
            return (
                <div className="flex items-center">
                    <div className="flex -space-x-1.5 overflow-hidden">
                        {activeUsers.map((u, i) => (
                            <div key={i} className="inline-block h-6 w-6 rounded-full ring-2 ring-white bg-brand-100 flex items-center justify-center text-[10px] font-bold text-brand-600 shadow-sm" title={`${u}が閲覧中`}>
                                {u.slice(0, 1)}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function SchedulePanel({ projects, showSchedule, onOpenCreateModal, onEditProject, onEditSchedule, activeUsers, onArchiveProject, onRestoreProject }) {
            const [tripTab, setTripTab] = useState('active');
            
            const displayProjects = useMemo(() => 
                projects.filter(p => p.type === 'trip' && (tripTab === 'active' ? p.status !== 'completed' : p.status === 'completed')), 
            [projects, tripTab]);

            const { startDate, daysArray } = useMemo(() => {
                let minDate = new Date(); minDate.setDate(minDate.getDate() - 7);
                let maxDate = new Date(); maxDate.setDate(maxDate.getDate() + 35);
                if (displayProjects.length > 0) {
                    const dates = [];
                    displayProjects.forEach(p => {
                        let members = []; try { if (p.memberSchedules) members = JSON.parse(p.memberSchedules); } catch(e){}
                        if (Array.isArray(members)) { members.forEach(m => { const sd = createLocalDate(m.startDate); const ed = createLocalDate(m.endDate); if(sd) dates.push(sd); if(ed) dates.push(ed); }); }
                        const psd = createLocalDate(p.startDate); const ped = createLocalDate(p.endDate); if(psd) dates.push(psd); if(ped) dates.push(ped);
                    });
                    if (dates.length > 0) {
                        const pMin = new Date(Math.min(...dates)); minDate = new Date(pMin); minDate.setDate(minDate.getDate() - 7);
                        const pMax = new Date(Math.max(...dates)); maxDate = new Date(pMax); maxDate.setDate(maxDate.getDate() + 7);
                    }
                }
                minDate.setHours(0,0,0,0); maxDate.setHours(0,0,0,0);
                const days = []; const curr = new Date(minDate); while (curr <= maxDate) { days.push(new Date(curr)); curr.setDate(curr.getDate() + 1); }
                return { startDate: minDate, daysArray: days };
            }, [displayProjects]);

            const monthHeaders = useMemo(() => {
                const headers = []; let currentMonth = ''; let count = 0;
                daysArray.forEach(d => {
                    const mStr = `${d.getFullYear()}/${d.getMonth() + 1}`;
                    if (mStr !== currentMonth) { if (currentMonth) headers.push({ name: currentMonth, count: count }); currentMonth = mStr; count = 1; }
                    else count++;
                });
                if (currentMonth) headers.push({ name: currentMonth, count: count });
                return headers;
            }, [daysArray]);

            const CELL_WIDTH = 40; const TOTAL_WIDTH = daysArray.length * CELL_WIDTH;
            const leftPanelRef = useRef(null); const rightPanelRef = useRef(null);
            const handleLeftScroll = (e) => { if (rightPanelRef.current) rightPanelRef.current.scrollTop = e.target.scrollTop; };
            const handleRightScroll = (e) => { if (leftPanelRef.current) leftPanelRef.current.scrollTop = e.target.scrollTop; };

            useEffect(() => {
                if (showSchedule && rightPanelRef.current) {
                    const now = new Date(); const diffTime = now - startDate; const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays >= 0) rightPanelRef.current.scrollTo({ left: (diffDays * CELL_WIDTH) - 100, behavior: 'auto' });
                }
            }, [showSchedule, startDate]);

            const getPosition = (dateStr) => {
                const d = createLocalDate(dateStr); if (!d) return null;
                const diffTime = d - startDate; return Math.floor(diffTime / (1000 * 60 * 60 * 24)) * CELL_WIDTH;
            };
            const getDuration = (startStr, endStr) => {
                const s = createLocalDate(startStr); const e = createLocalDate(endStr); if (!s || !e) return 0;
                return (Math.floor((e - s) / (1000 * 60 * 60 * 24)) + 1) * CELL_WIDTH;
            };

            return (
                <div className="h-full flex flex-col bg-slate-50 overflow-hidden w-full relative">
                    <div className="p-5 border-b border-slate-200 bg-white/80 backdrop-blur flex justify-between items-center z-20 shadow-sm">
                        <div className="flex flex-col gap-2">
                            <h2 className="text-xl font-bold text-slate-800 flex items-center gap-4">
                                <span className="flex items-center"><MapPinIcon className="w-6 h-6 mr-2 text-brand-600"/>現地出張スケジュール</span>
                                <ActiveUserIndicator activeUsers={activeUsers} />
                            </h2>
                            <div className="flex bg-slate-100 p-1 rounded-lg w-fit">
                                <button onClick={() => setTripTab('active')} className={`px-4 py-1 rounded-md text-xs font-bold transition-all ${tripTab === 'active' ? 'bg-white text-brand-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>進行中</button>
                                <button onClick={() => setTripTab('completed')} className={`px-4 py-1 rounded-md text-xs font-bold transition-all ${tripTab === 'completed' ? 'bg-white text-brand-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>完了</button>
                            </div>
                        </div>
                        <button onClick={() => onOpenCreateModal()} className="inline-flex items-center px-4 py-2 bg-brand-600 text-white rounded-full hover:bg-brand-700 transition shadow-lg font-bold text-sm">
                            <PlusIcon className="w-4 h-4 mr-1.5"/> 出張を追加
                        </button>
                    </div>

                    <div className="flex-1 flex overflow-hidden bg-white">
                        <div ref={leftPanelRef} onScroll={handleLeftScroll} className="w-[480px] flex-shrink-0 border-r border-slate-200 bg-white overflow-y-auto z-10 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
                            <div className="sticky top-0 z-20 bg-slate-50 border-b border-slate-200 h-14 flex items-center px-4 text-sm font-bold text-slate-500 uppercase">
                                <div className="w-2/3">Project Info</div>
                                <div className="w-1/3 pl-2">Members</div>
                            </div>
                            <div className="pb-10">
                                {displayProjects.length === 0 && <div className="text-center py-20 text-slate-400 text-sm">{tripTab === 'active' ? '出張予定はありません' : '完了した出張はありません'}</div>}
                                {displayProjects.map(project => {
                                    let members = []; try { members = JSON.parse(project.memberSchedules || '[]'); } catch(e){}
                                    return (
                                        <div key={project.id} className="border-b border-slate-100 group hover:bg-slate-50 transition-colors flex items-stretch" style={{ height: getRowHeight(project) }}>
                                            <div className="w-2/3 p-4 flex flex-col justify-between border-r border-slate-50 cursor-pointer" onClick={() => onEditProject(project)}>
                                                <div>
                                                    <div className="flex items-center justify-between mb-2">
                                                        {project.siteName && <div className="px-2 py-0.5 rounded-full bg-brand-50 text-brand-600 text-xs font-bold truncate max-w-full">{project.siteName}</div>}
                                                        {project.status !== 'completed' ? (
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); onArchiveProject(project.id); }} 
                                                                className="p-1.5 text-slate-300 hover:text-brand-600 hover:bg-brand-50 rounded-full transition-all"
                                                                title="完了へ移動"
                                                            >
                                                                <ArchiveIcon className="w-4 h-4" />
                                                            </button>
                                                        ) : (
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); onRestoreProject(project.id); }} 
                                                                className="p-1.5 text-slate-300 hover:text-emerald-600 hover:bg-emerald-50 rounded-full transition-all"
                                                                title="進行中に戻す"
                                                            >
                                                                <RotateCcwIcon className="w-4 h-4" />
                                                            </button>
                                                        )}
                                                    </div>
                                                    <h3 className="text-base font-bold leading-snug text-slate-700 line-clamp-2 mb-2">{project.name}</h3>
                                                    <div className="flex flex-col gap-1 text-xs text-slate-500 font-mono">
                                                        {(project.pwbs || project.sakuban) && (<div><span className="w-16 text-slate-400">PWBS-作番:</span><span className="font-bold">{project.pwbs || '-'}{project.sakuban ? `-${project.sakuban}` : ''}</span></div>)}
                                                        {project.estimateNo && (<div><span className="w-16 text-slate-400">見積No:</span><span className="font-bold">{project.estimateNo}</span></div>)}
                                                    </div>
                                                </div>
                                                <div className="flex items-center text-xs font-mono text-slate-400 mt-2 pt-2 border-t border-slate-100/50">
                                                    <CalendarIcon className="w-3.5 h-3.5 mr-1.5"/><span>{formatDateShort(project.startDate)} - {formatDateShort(project.endDate)}</span>
                                                </div>
                                            </div>
                                            <div className="w-1/3 p-3 bg-slate-50/30 flex flex-col justify-center">
                                                <div className="space-y-2 w-full">
                                                    {members.map((m, idx) => (
                                                        <div key={idx} className="flex items-center text-sm text-slate-700 bg-white border border-slate-100 rounded px-2 py-1 shadow-sm h-8">
                                                            <UserIcon className="w-3.5 h-3.5 mr-1.5 text-slate-400 flex-shrink-0"/><span className="truncate font-bold flex-1">{m.name}</span>
                                                        </div>
                                                    ))}
                                                    {members.length === 0 && <span className="text-xs text-slate-300 italic pl-1">未定</span>}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="flex-1 flex flex-col bg-white overflow-hidden">
                            <div ref={rightPanelRef} onScroll={handleRightScroll} className="flex-1 overflow-auto custom-scrollbar relative">
                                <div style={{ width: TOTAL_WIDTH }} className="relative bg-white min-h-full">
                                    <div className="sticky top-0 z-30 shadow-sm bg-white/95 backdrop-blur">
                                        <div className="flex h-6 border-b border-slate-100 bg-slate-50/50">
                                            {monthHeaders.map((m, i) => (<div key={i} className="flex items-center px-2 text-xs font-bold text-slate-500 border-r border-slate-200/50 uppercase tracking-wider" style={{ width: m.count * CELL_WIDTH }}>{m.name}</div>))}
                                        </div>
                                        <div className="flex h-8 border-b border-slate-200">
                                            {daysArray.map((d, i) => {
                                                const isSat = d.getDay() === 6; const isSun = d.getDay() === 0;
                                                return (<div key={i} className={`flex-shrink-0 border-r border-slate-100 flex flex-col items-center justify-center ${isSat ? 'bg-blue-50/40' : isSun ? 'bg-red-50/40' : ''}`} style={{ width: CELL_WIDTH }}><span className={`text-xs font-bold ${isSat ? 'text-blue-500' : isSun ? 'text-red-500' : 'text-slate-400'}`}>{d.getDate()}</span></div>);
                                            })}
                                        </div>
                                    </div>
                                    <div>
                                        {displayProjects.map((project) => {
                                            let members = []; try { members = JSON.parse(project.memberSchedules || '[]'); } catch(e){}
                                            return (
                                                <div key={project.id} className="border-b border-slate-50 relative group transition hover:bg-slate-50/30" style={{ height: getRowHeight(project) }}>
                                                    <div className="absolute inset-0 flex pointer-events-none">
                                                        {daysArray.map((d, i) => (<div key={i} className={`flex-shrink-0 border-r border-slate-100 h-full ${d.getDay() === 0 || d.getDay() === 6 ? 'bg-slate-50/30' : ''}`} style={{ width: CELL_WIDTH }}></div>))}
                                                    </div>
                                                    {/* ★修正: p-3 を py-3 px-0 に変更して横方向のズレを解消 */}
                                                    <div className="absolute inset-0 flex flex-col justify-center pointer-events-none py-3 px-0 space-y-2">
                                                        {members.map((m, mIdx) => {
                                                            const left = getPosition(m.startDate); const width = getDuration(m.startDate, m.endDate);
                                                            if (left === null || width === 0) return <div key={mIdx} className="relative w-full h-8"></div>;
                                                            return (
                                                                <div key={mIdx} className="relative w-full h-8 flex items-center">
                                                                    <div className={`absolute h-6 rounded-md bg-gradient-to-r shadow-sm border cursor-pointer pointer-events-auto hover:brightness-110 flex items-center overflow-hidden transition-all hover:scale-[1.01] ${project.status === 'completed' ? 'from-slate-400 to-slate-500 border-slate-500/20 grayscale opacity-60' : 'from-accent-500 to-accent-600 border-accent-600/20'}`} style={{ left: left, width: width }} onClick={() => onEditSchedule({ originalProject: project, memberIndex: mIdx, name: m.name, startDate: m.startDate, endDate: m.endDate })} title={`${m.name} (${m.startDate} ~ ${m.endDate})`}>
                                                                        <div className={`absolute left-0 top-0 bottom-0 z-10 flex items-center justify-center ${project.status === 'completed' ? 'bg-slate-300' : 'bg-orange-400/90'}`} style={{ width: CELL_WIDTH }}><span className="text-[9px] text-white font-bold scale-90">移動</span></div>
                                                                        {width > CELL_WIDTH && <div className={`absolute right-0 top-0 bottom-0 z-10 flex items-center justify-center ${project.status === 'completed' ? 'bg-slate-300' : 'bg-orange-400/90'}`} style={{ width: CELL_WIDTH }}><span className="text-[9px] text-white font-bold scale-90">移動</span></div>}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    {(() => {
                                        const now = new Date(); const left = getPosition(now.getFullYear() + "-" + (now.getMonth() + 1) + "-" + now.getDate());
                                        if (left !== null && left >= 0 && left <= TOTAL_WIDTH) {
                                            return (<div className="absolute top-8 bottom-0 w-px bg-red-500 z-10 pointer-events-none" style={{ left: left + (CELL_WIDTH/2) }}><div className="w-2 h-2 rounded-full bg-red-500 -ml-1 -mt-1 shadow-sm"></div></div>);
                                        } return null;
                                    })()}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="p-3 text-sm text-slate-400 bg-white border-t border-slate-200 text-right flex justify-between items-center px-6 z-20">
                         <div className="flex items-center gap-4">
                             <div className="flex items-center gap-1.5"><div className="w-2 h-2 bg-orange-400 rounded-full"></div><span className="text-xs font-medium">移動日</span></div>
                             <div className="flex items-center gap-1.5"><div className="w-2 h-2 bg-accent-500 rounded-full"></div><span className="text-xs font-medium">現地作業</span></div>
                             {tripTab === 'completed' && <div className="flex items-center gap-1.5"><div className="w-2 h-2 bg-slate-400 rounded-full"></div><span className="text-xs font-medium">完了済み出張</span></div>}
                        </div>
                        <span className="font-medium opacity-60">左右にドラッグしてスクロール</span>
                    </div>
                </div>
            );
        }

        function MemoSection({ project, onUpdateData }) {
            const [memo, setMemo] = useState('');
            const [isSending, setIsSending] = useState(false);
            const [parsedMemos, setParsedMemos] = useState([]);
            const [editingEntry, setEditingEntry] = useState(null);
            const [editText, setEditText] = useState('');
            const [isSavingEdit, setIsSavingEdit] = useState(false);

            useEffect(() => {
                if (!project.description) { setParsedMemos([]); return; }
                const rawEntries = project.description.split(/(?=\[\d{4}\/\d{2}\/\d{2} \d{2}:\d{2} )/g);
                const parsed = rawEntries.map(entry => {
                    const trimmed = entry.trim(); if (!trimmed) return null;
                    const match = trimmed.match(/^\[(\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}) (.*?)\]\s+([\s\S]*)$/);
                    return match ? { date: match[1], name: match[2], text: match[3], raw: trimmed, valid: true } : { text: trimmed, raw: trimmed, valid: false };
                }).filter(e => e !== null);
                setParsedMemos(parsed);
            }, [project.description]);

            const handlePost = (e) => {
                e.preventDefault(); if (!memo.trim()) return;
                setIsSending(true);
                backend.addMemo(project.id, memo, (data) => { setIsSending(false); setMemo(''); onUpdateData(data); }, (err) => { setIsSending(false); alert("失敗: " + err); });
            };
            const handleDelete = (entryContent) => {
                if (!confirm("削除しますか？")) return;
                backend.deleteMemo(project.id, entryContent, onUpdateData, (err) => alert("失敗: " + err));
            };
            const startEdit = (m) => { setEditingEntry(m.raw); setEditText(m.text); };
            const saveEdit = () => {
                if (!editText.trim()) return; setIsSavingEdit(true);
                backend.editMemo(project.id, editingEntry, editText, (data) => { setIsSavingEdit(false); setEditingEntry(null); onUpdateData(data); }, (err) => { setIsSavingEdit(false); alert("失敗: " + err); });
            };

            return (
                <div className="mb-4">
                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">プロジェクトログ</label>
                    <div className="bg-slate-50 border border-slate-200 rounded-xl p-3 mb-3 h-48 overflow-y-auto overscroll-y-contain custom-scrollbar space-y-3">
                        {parsedMemos.length === 0 ? <div className="text-center text-slate-400 text-sm py-4 italic">No logs recorded</div> : (
                            parsedMemos.map((m, idx) => (
                                <div key={idx} className="bg-white p-3 rounded-lg border border-slate-100 shadow-sm group">
                                    {editingEntry === m.raw ? (
                                        <div className="flex flex-col gap-2">
                                            <textarea value={editText} onChange={(e) => setEditText(e.target.value)} className="w-full text-sm border border-brand-300 rounded p-2 focus:ring-2 focus:ring-brand-500 outline-none resize-none h-20 bg-brand-50/30"></textarea>
                                            <div className="flex justify-end gap-2">
                                                <button onClick={() => setEditingEntry(null)} className="text-xs text-slate-500 px-3 py-1 font-medium">キャンセル</button>
                                                <button onClick={saveEdit} disabled={isSavingEdit} className="flex items-center text-xs text-white bg-brand-600 px-3 py-1 rounded font-bold transition shadow-sm">
                                                    {isSavingEdit ? <RefreshIcon className="w-3 h-3 animate-spin mr-1"/> : <SaveIcon className="w-3 h-3 mr-1"/>} 保存
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="flex justify-between items-center mb-1 border-b border-slate-50 pb-1">
                                                <div className="flex items-center gap-1.5 flex-1 min-w-0">
                                                    <UserIcon className="w-3.5 h-3.5 text-slate-400 flex-shrink-0" /><span className="font-bold text-xs text-slate-700 truncate">{m.name?.split('@')[0]}</span>
                                                    <span className="text-xs text-slate-400 font-mono flex-shrink-0 ml-auto">{m.date}</span>
                                                </div>
                                                <div className="flex gap-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onClick={() => startEdit(m)} className="p-1 text-slate-300 hover:text-brand-500 rounded"><PencilIcon className="w-3 h-3" /></button>
                                                    <button onClick={() => handleDelete(m.raw)} className="p-1 text-slate-300 hover:text-red-500 rounded"><TrashIcon className="w-3 h-3" /></button>
                                                </div>
                                            </div>
                                            <div className="text-sm text-slate-600 whitespace-pre-wrap break-words leading-relaxed">{m.text}</div>
                                        </>
                                    )}
                                </div>
                            ))
                        )}
                    </div>
                    <div className="flex flex-col gap-2 bg-white p-2 rounded-lg border border-slate-200 shadow-sm">
                        <div className="flex gap-2 items-end">
                            <textarea value={memo} onChange={(e) => setMemo(e.target.value)} placeholder="メッセージを入力..." className="flex-1 text-sm outline-none resize-none h-12 bg-transparent leading-relaxed"></textarea>
                            <button onClick={handlePost} disabled={isSending || !memo.trim()} className="bg-brand-600 text-white rounded-lg px-3 py-2 text-xs font-bold hover:bg-brand-700 disabled:bg-slate-300 transition-colors shadow-sm">
                                {isSending ? <RefreshIcon className="w-4 h-4 animate-spin"/> : <SendIcon className="w-4 h-4"/>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const CACHE_KEY = 'mm_projects_v1';
            const [projects, setProjects] = useState(() => { try { const cached = localStorage.getItem(CACHE_KEY); return cached ? JSON.parse(cached) : []; } catch(e) { return []; } });
            const [loading, setLoading] = useState(() => !localStorage.getItem(CACHE_KEY));
            const [activeUsers, setActiveUsers] = useState([]);
            const [expandedProjectIds, setExpandedProjectIds] = useState(new Set());
            const [tab, setTab] = useState('active');
            const [activeModal, setActiveModal] = useState(null);
            const [projectForm, setProjectForm] = useState({ name: '', siteName: '', code: '', pwbs: '', sakuban: '', estimateNo: '', deadline: '', description: '', skipWbs: false, startDate: '', endDate: '', memberSchedules: [{ name: '', startDate: '', endDate: '' }] });
            const [syncing, setSyncing] = useState(false);
            const [activeWbsUrl, setActiveWbsUrl] = useState(null);
            const [showSchedule, setShowSchedule] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [editingSchedule, setEditingSchedule] = useState(null);
            const [editForm, setEditForm] = useState(null);
            const isSaving = useRef(false);
            const [toasts, setToasts] = useState([]);

            const addToast = (message, type = 'info') => {
                const id = Date.now(); setToasts(prev => [...prev, { id, message, type }]);
                if (type !== 'loading') setTimeout(() => removeToast(id), 3000);
                return id;
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));
            const updateToast = (id, message, type) => {
                setToasts(prev => prev.map(t => t.id === id ? { ...t, message, type } : t));
                if (type !== 'loading') setTimeout(() => removeToast(id), 3000);
            };

            useEffect(() => { if (projects.length > 0) localStorage.setItem(CACHE_KEY, JSON.stringify(projects)); }, [projects]);

            const fetchData = useCallback(() => {
                if (isSaving.current) return;
                backend.getData((data) => {
                    if (isSaving.current) return;
                    setProjects(prev => JSON.stringify(prev) !== JSON.stringify(data.projects || []) ? (data.projects || []) : prev);
                    setLoading(false);
                }, (err) => console.error("Fetch error:", err));
            }, []);

            const handleSyncWbs = useCallback((isSilent = false) => {
                if(syncing) return; setSyncing(true);
                let toastId = isSilent ? null : addToast('WBS同期中...', 'loading');
                backend.syncWbsProgress((data) => {
                    setProjects(data.projects || []); setSyncing(false);
                    if (toastId) updateToast(toastId, '同期完了', 'success');
                }, (err) => {
                    console.error("Sync error:", err); setSyncing(false);
                    if (toastId) updateToast(toastId, '同期エラー', 'error');
                });
            }, [syncing]);

            useEffect(() => {
                fetchData(); const interval = setInterval(fetchData, 8000);
                const initialSyncTimer = setTimeout(() => { if (!isSaving.current) handleSyncWbs(true); }, 2000);
                const autoSyncInterval = setInterval(() => { if (!isSaving.current && !document.hidden) handleSyncWbs(true); }, 60000);
                const hb = () => backend.heartbeat((data) => setActiveUsers(data.activeUsers || []), (err) => console.error(err));
                hb(); const hbInterval = setInterval(hb, 60000);
                return () => { clearInterval(interval); clearTimeout(initialSyncTimer); clearInterval(autoSyncInterval); clearInterval(hbInterval); };
            }, [handleSyncWbs, fetchData]);

            const handleUpdateData = (newData) => setProjects(newData.projects || []);
            const toggleExpand = (id) => setExpandedProjectIds(prev => { const next = new Set(prev); if (next.has(id)) next.delete(id); else next.add(id); return next; });
            const handleSelectProject = (project) => {
                if (project.wbsUrl) {
                    let url = project.wbsUrl; if (url.includes('/preview')) url = url.replace(/\/preview.*$/, '/edit');
                    setActiveWbsUrl(url);
                } else setActiveWbsUrl(null);
            };

            // ★スマートペースト機能の復元
            const handleSmartPaste = (e) => {
                const text = e.target.value;
                if (!text) return;
                const lines = text.trim().split(/\r?\n/);
                if (lines.length === 0) return;
                const cols = lines[0].split('\t').map(c => c.trim().replace(/^"|"$/g, ''));
                if (cols.length < 2) return;
                let estimateNo = cols[0] || '';
                let name = cols[1] || '';
                let siteName = cols[2] || '';
                const col3 = cols[3] || '';
                if (col3 && !col3.includes('担当') && !col3.includes('CSPA') && col3.length < 15) {
                    siteName = siteName ? `${siteName} ${col3}` : col3;
                }
                let pwbs = ''; let sakuban = ''; let code = ''; let deadline = '';
                for (let i = 4; i < cols.length; i++) {
                    const val = cols[i]; if (!val) continue;
                    if (!deadline && val.match(/\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/)) {
                        const m = val.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
                        if (m) deadline = `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}`;
                        continue;
                    }
                    if (!pwbs && val.match(/^[A-Z]\d{3}$/)) { pwbs = val; continue; }
                    if (!sakuban && val.match(/^\d{5}$/)) { sakuban = val; continue; }
                    if (!code && i === 6 && !val.match(/\d{4}[\/\-]/)) { code = val; continue; }
                }
                setProjectForm(prev => ({ ...prev, name, siteName, estimateNo, pwbs, sakuban, code, deadline }));
            };

            // ★見積書検索
            const handleSearchEstimate = (estimateNo) => {
                const toastId = addToast(`見積No.${estimateNo} を検索中...`, 'loading');
                backend.getFileUrlByEstimateNo(estimateNo, (url) => {
                    removeToast(toastId);
                    if (url) {
                        window.open(url, '_blank');
                    } else {
                        addToast(`見積No.${estimateNo} のファイルが見つかりませんでした`, 'error');
                    }
                }, (err) => {
                    removeToast(toastId);
                    addToast("検索エラー: " + err, 'error');
                });
            };

            const handleCreateProject = (e) => {
                e.preventDefault(); isSaving.current = true;
                const isTrip = activeModal === 'trip'; const toastId = addToast('登録中...', 'loading');
                let calculatedStart = projectForm.startDate; let calculatedEnd = projectForm.endDate;
                if (isTrip) {
                    const validMembers = (projectForm.memberSchedules || []).filter(m => m.startDate && m.endDate);
                    if (validMembers.length === 0) { isSaving.current = false; removeToast(toastId); alert("期間を設定してください"); return; }
                    calculatedStart = new Date(Math.min(...validMembers.map(m => new Date(m.startDate)))).toISOString().split('T')[0];
                    calculatedEnd = new Date(Math.max(...validMembers.map(m => new Date(m.endDate)))).toISOString().split('T')[0];
                }
                const cleanData = { ...projectForm, startDate: calculatedStart, endDate: calculatedEnd, skipWbs: isTrip ? true : projectForm.skipWbs, type: isTrip ? 'trip' : 'normal', status: 'active', projectStatus: isTrip ? '出張中' : "資料受領待ち", memberSchedules: JSON.stringify(projectForm.memberSchedules || []) };
                setActiveModal(null); setProjectForm({ name: '', siteName: '', code: '', pwbs: '', sakuban: '', estimateNo: '', deadline: '', description: '', skipWbs: false, startDate: '', endDate: '', memberSchedules: [{name: '', startDate: '', endDate: ''}] });
                backend.createProject(cleanData, (data) => { isSaving.current = false; handleUpdateData(data); updateToast(toastId, '完了', 'success'); }, (err) => { isSaving.current = false; updateToast(toastId, 'エラー: ' + err, 'error'); });
            };

            const handleUpdateProject = (id, data) => {
                const p = projects.find(p => p.id === id); if (!p) return;
                const updated = { ...p, ...data }; setProjects(projects.map(prj => prj.id === id ? updated : prj));
                isSaving.current = true; const toastId = addToast('保存中...', 'loading');
                backend.updateProject(updated, (resData) => { isSaving.current = false; handleUpdateData(resData); updateToast(toastId, '完了', 'success'); }, (err) => { isSaving.current = false; updateToast(toastId, 'エラー', 'error'); });
            };

            const handleDeleteProject = (id) => {
                if(!confirm("削除しますか？")) return; isSaving.current = true; const toastId = addToast('削除中...', 'loading');
                backend.deleteProject(id, (data) => { isSaving.current = false; handleUpdateData(data); setEditingProject(null); updateToast(toastId, '完了', 'success'); }, (err) => { isSaving.current = false; updateToast(toastId, 'エラー: ' + err, 'error'); });
            };

            const handleArchiveProject = (id) => { if(confirm("完了（アーカイブ）しますか？")) handleUpdateProject(id, { status: 'completed' }); };
            const handleRestoreProject = (id) => { if(confirm("進行中に戻しますか？")) handleUpdateProject(id, { status: 'active' }); };

            const openEditModal = (project) => {
                let ms = []; try { ms = typeof project.memberSchedules === 'string' ? JSON.parse(project.memberSchedules) : (project.memberSchedules || []); } catch(e) {}
                setEditForm({ ...project, memberSchedules: Array.isArray(ms) ? ms : [] }); setEditingProject(project);
            };

            const handleEditSchedule = (row) => setEditingSchedule({ project: row.originalProject, memberIndex: row.memberIndex, data: { name: row.name, startDate: row.startDate, endDate: row.endDate } });
            const handleSaveScheduleUpdate = (e) => {
                e.preventDefault(); const { project, memberIndex, data } = editingSchedule;
                let ms = []; try { ms = typeof project.memberSchedules === 'string' ? JSON.parse(project.memberSchedules) : project.memberSchedules; } catch(e) {}
                if (Array.isArray(ms) && ms[memberIndex]) {
                    ms[memberIndex] = { ...ms[memberIndex], ...data };
                    const starts = ms.map(m => new Date(m.startDate).getTime()).filter(t => !isNaN(t));
                    const ends = ms.map(m => new Date(m.endDate).getTime()).filter(t => !isNaN(t));
                    handleUpdateProject(project.id, { memberSchedules: JSON.stringify(ms), startDate: new Date(Math.min(...starts)).toISOString().split('T')[0], endDate: new Date(Math.max(...ends)).toISOString().split('T')[0] });
                }
                setEditingSchedule(null);
            };

            const handleSaveSettings = (e) => {
                e.preventDefault(); const fd = new FormData(e.target);
                let sd = fd.get('startDate'); let ed = fd.get('endDate');
                if (editingProject.type === 'trip') {
                     const ms = editForm.memberSchedules || [];
                     const starts = ms.map(m => new Date(m.startDate).getTime()).filter(t => !isNaN(t));
                     const ends = ms.map(m => new Date(m.endDate).getTime()).filter(t => !isNaN(t));
                     if (starts.length > 0) sd = new Date(Math.min(...starts)).toISOString().split('T')[0];
                     if (ends.length > 0) ed = new Date(Math.max(...ends)).toISOString().split('T')[0];
                }
                handleUpdateProject(editingProject.id, { name: fd.get('name'), code: fd.get('code'), pwbs: fd.get('pwbs'), sakuban: fd.get('sakuban'), estimateNo: fd.get('estimateNo'), deadline: fd.get('deadline'), siteName: fd.get('siteName'), wbsUrl: fd.get('wbsUrl'), startDate: sd, endDate: ed, memberSchedules: JSON.stringify(editForm.memberSchedules) });
                setEditingProject(null);
            };

            const addMemberToForm = (setter, cur) => {
                const ms = cur.memberSchedules || [];
                setter({ ...cur, memberSchedules: [...ms, { name: '', startDate: ms.length > 0 ? ms[ms.length-1].startDate : '', endDate: ms.length > 0 ? ms[ms.length-1].endDate : '' }] });
            };
            const updateMemberInForm = (setter, cur, idx, field, val) => { const ms = [...cur.memberSchedules]; ms[idx] = { ...ms[idx], [field]: val }; setter({ ...cur, memberSchedules: ms }); };
            const removeMemberFromForm = (setter, cur, idx) => { const ms = [...cur.memberSchedules]; ms.splice(idx, 1); setter({ ...cur, memberSchedules: ms }); };

            const getStatusBannerColor = (s) => {
                 switch (s || '') {
                    case "作業開始前": return 'bg-sky-300'; case "資料受領待ち": case "社内レビュー待ち": case "ムラシスレビュー待ち": case "システム検証待ち": case "第三者検証待ち": case "VAO/MCS試験待ち": return 'bg-amber-400';
                    case "成果物作成中": return 'bg-lime-400'; case "統合試験準備中": return 'bg-emerald-300'; case "統合試験中": return 'bg-emerald-600'; case "社内検証準備中": return 'bg-rose-300'; case "社内検証中": return 'bg-rose-500';
                    case "システム検証中": case "VAO/MCS試験中": return 'bg-purple-400'; case "第三者検証中": return 'bg-purple-700'; case "完了": case "請求済": return 'bg-blue-800'; case "作業保留中": return 'bg-red-500'; default: return 'bg-brand-600';
                 }
            };

            const filteredProjects = projects.filter(p => {
                const isNormal = !p.type || p.type === 'normal';
                if (tab === 'active') return p.status !== 'completed' && isNormal;
                return p.status === 'completed' && isNormal;
            });

            const renderProjectList = (isCompact) => {
                if (loading) return <div className="text-center py-10 text-sm w-full">Loading...</div>;
                if (filteredProjects.length === 0) return <div className="text-center py-10 border-2 border-dashed border-slate-200 rounded-xl bg-white w-full"><p className="text-sm text-slate-400">プロジェクトなし</p></div>;
                if (!isCompact) {
                    return (
                        <div className="space-y-4">
                            {filteredProjects.map(p => {
                                const isExpanded = expandedProjectIds.has(p.id);
                                return (
                                    <div key={p.id} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-all">
                                        <div className="relative cursor-pointer" onClick={(e) => { if (e.target.closest('a') || e.target.closest('button') || e.target.closest('select')) return; toggleExpand(p.id); }}>
                                            <div className={`h-2 w-full transition-colors duration-500 ${getStatusBannerColor(p.projectStatus)}`}></div>
                                            <div className="p-4 flex flex-col md:flex-row md:items-center justify-between gap-4">
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        {p.siteName && <div className="flex items-center text-sm font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded truncate max-w-[200px]"><MapPinIcon className="w-3 h-3 mr-1" />{p.siteName}</div>}
                                                        <span className={`inline-block text-sm px-2 py-0.5 rounded text-white font-medium ${getStatusBannerColor(p.projectStatus)}`}>{p.projectStatus || '未設定'}</span>
                                                    </div>
                                                    <h3 className="text-xl font-bold text-slate-900 leading-tight truncate mb-1">{p.name}</h3>
                                                    <div className="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-slate-500 font-mono">
                                                        {p.pwbs && <span className="flex items-center"><span className="text-slate-400 mr-1">PWBS-作番:</span>{p.pwbs}{p.sakuban ? `-${p.sakuban}` : ''}</span>}
                                                        {/* ★見積No.のリンク化 */}
                                                        {p.estimateNo && (
                                                            <span className="flex items-center">
                                                                <span className="text-slate-400 mr-1">見積依頼書(リンク):</span>
                                                                <button 
                                                                    onClick={(e) => { e.stopPropagation(); handleSearchEstimate(p.estimateNo); }}
                                                                    className="font-bold hover:underline hover:text-brand-600 text-left"
                                                                    title="関連ファイルを検索して開く"
                                                                >
                                                                    {p.estimateNo}
                                                                </button>
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-6 flex-shrink-0 self-end md:self-center">
                                                    <div className="text-right flex flex-col items-end text-sm font-mono text-slate-500">
                                                        <div><span className="font-bold text-slate-700 mr-1 text-base">{formatCost(p.manDays, 1)}</span>(人日)</div>
                                                        <div><span className="font-bold text-slate-700 mr-1 text-base">{formatCost(p.manMonths, 2)}</span>(人月)</div>
                                                    </div>
                                                    <div className="text-right flex flex-col items-end">
                                                        <div className="text-[10px] text-slate-400 uppercase font-bold flex items-center gap-1">Progress<button onClick={(e) => { e.stopPropagation(); handleSyncWbs(); }} className="hover:text-brand-600"><RefreshIcon className={`w-3 h-3 ${syncing ? 'animate-spin' : ''}`} /></button></div>
                                                        <div className="text-4xl font-bold text-slate-700 leading-none">{formatProgress(p.wbsProgress)}</div>
                                                    </div>
                                                    <button className={`flex flex-col items-center justify-center w-20 h-20 rounded-xl border transition-all ${p.wbsUrl ? 'bg-blue-600 text-white border-blue-700 hover:bg-blue-700 cursor-pointer shadow-md' : 'bg-slate-50 text-slate-300 border-slate-100 cursor-not-allowed'}`} onClick={(e) => { e.stopPropagation(); if (p.wbsUrl) handleSelectProject(p); }}>
                                                        <FileTextIcon className="w-8 h-8 mb-1" /><span className="text-sm font-bold">WBS</span>
                                                    </button>
                                                    {/* ★修正: Vボタン押下でも展開/閉じるを実行するようにonClickを追加 */}
                                                    <button 
                                                        className="text-slate-400 p-2 hover:bg-slate-100 rounded-full"
                                                        onClick={(e) => { e.stopPropagation(); toggleExpand(p.id); }}
                                                    >
                                                        {isExpanded ? <ChevronUpIcon className="w-6 h-6"/> : <ChevronDownIcon className="w-6 h-6"/>}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {isExpanded && (
                                            <div className="border-t border-slate-100 bg-slate-50 p-4 animate-expand-fade-in">
                                                <div className="mb-4 flex flex-col sm:flex-row justify-between items-end gap-4">
                                                    <div className="w-full sm:w-auto">
                                                        <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">ステータス変更</label>
                                                        <div className="relative">
                                                            <select value={p.projectStatus} onChange={(e) => handleUpdateProject(p.id, { projectStatus: e.target.value })} className="w-full sm:w-64 appearance-none bg-white border border-slate-300 text-slate-900 text-sm rounded focus:ring-brand-500 focus:border-brand-500 block p-2 font-bold shadow-sm">
                                                                {PROJECT_STATUS_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                            </select>
                                                            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-700"><ChevronDownIcon className="w-4 h-4"/></div>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        {p.status === 'active' ? (
                                                            <button onClick={() => handleArchiveProject(p.id)} className="text-xs font-bold text-slate-500 hover:text-brand-600 flex items-center px-3 py-2 rounded hover:bg-white transition"><ArchiveIcon className="w-4 h-4 mr-2"/> PJをCLOSEし完了へ移動</button>
                                                        ) : (
                                                            <button onClick={() => handleRestoreProject(p.id)} className="text-xs font-bold text-white bg-green-600 hover:bg-green-700 px-3 py-2 rounded transition">再開</button>
                                                        )}
                                                    </div>
                                                </div>

                                                <div className="flex flex-col lg:flex-row gap-4 mb-4">
                                                    <div className="flex-1 min-w-0">
                                                        <h4 className="text-[10px] font-bold text-slate-400 uppercase mb-2">工程進捗状況</h4>
                                                        <div className="flex items-center gap-2 overflow-x-auto p-2 custom-scrollbar">
                                                            {(() => {
                                                                const activeIdx = TARGET_TASKS.findIndex(t => !p[`task_${t.key}_actual`] && p[`task_${t.key}_status`] !== '完了' && p[`task_${t.key}_status`] !== '作業不要');
                                                                return TARGET_TASKS.map((task, idx) => {
                                                                    const status = p[`task_${task.key}_status`] || '-';
                                                                    const hasActual = p[`task_${task.key}_actual`] && p[`task_${task.key}_actual`] !== '';
                                                                    return (
                                                                        <React.Fragment key={task.key}>
                                                                            <div className={`flex-shrink-0 w-36 bg-white border rounded p-2 text-[10px] shadow-sm flex flex-col justify-between h-full transition-all ${(hasActual || status === '作業不要') ? 'bg-gray-100 text-gray-400 border-slate-200' : idx === activeIdx ? 'ring-2 ring-brand-500 border-transparent z-10 scale-[1.02]' : 'border-slate-200'}`}>
                                                                                <div className="flex justify-between items-center mb-1 border-b border-slate-100 pb-1"><span className={`font-bold truncate ${(hasActual || status === '作業不要') ? 'text-gray-500' : 'text-slate-700'}`}>{task.shortName || task.name}</span>{idx === activeIdx && <span className="w-2 h-2 rounded-full bg-brand-500 ml-1"></span>}</div>
                                                                                <div className="text-center py-1"><span className={`font-bold text-xs ${status === '完了' ? (hasActual ? 'text-green-800/50' : 'text-green-600') : (hasActual || status === '作業不要') ? 'text-gray-400' : 'text-slate-600'}`}>{status}</span></div>
                                                                                <div className={`space-y-0.5 ${(hasActual || status === '作業不要') ? 'text-gray-400' : 'text-slate-500'}`}>
                                                                                    <div className="flex justify-between"><span>予定:</span> <span>{formatDateShort(p[`task_${task.key}_plan`])}</span></div>
                                                                                    <div className="flex justify-between"><span>完了:</span> <span>{formatDateShort(p[`task_${task.key}_actual`])}</span></div>
                                                                                    <div className="flex justify-between border-t pt-0.5 mt-0.5"><UserIcon className="w-3 h-3 text-slate-400 flex-shrink-0" /><span className="text-right truncate flex-1 ml-1">{p[`task_${task.key}_assignee`] || '-'}</span></div>
                                                                                </div>
                                                                            </div>
                                                                            {idx < TARGET_TASKS.length - 1 && <div className="text-slate-300 font-bold text-lg flex-shrink-0">&gt;</div>}
                                                                        </React.Fragment>
                                                                    );
                                                                });
                                                            })()}
                                                        </div>
                                                    </div>
                                                    <div className="flex-shrink-0 pt-6 flex flex-col gap-3 w-32">
                                                        <button onClick={() => openEditModal(p)} className="w-full flex items-center justify-center text-xs font-bold text-slate-600 bg-white border border-slate-300 px-3 py-2 rounded shadow-sm hover:bg-slate-50 transition"><SettingsIcon className="w-4 h-4 mr-1.5" /> PJ詳細</button>
                                                        <div className="bg-white border border-slate-200 rounded-lg p-2.5 shadow-sm space-y-2">
                                                            <MultiSelect label="PL" options={MEMBER_OPTIONS} value={p.pl || ''} onChange={(val) => handleUpdateProject(p.id, { pl: val })} />
                                                            <MultiSelect label="作業者" options={MEMBER_OPTIONS} value={p.worker || ''} onChange={(val) => handleUpdateProject(p.id, { worker: val })} />
                                                        </div>
                                                    </div>
                                                </div>
                                                <MemoSection project={p} onUpdateData={handleUpdateData} />
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    );
                } else {
                    return (
                        <div className="space-y-3">
                            {filteredProjects.map(p => (
                                <div key={p.id} className={`bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden transition-all ${activeWbsUrl && activeWbsUrl.includes(p.wbsUrl?.replace(/\/edit.*$/, '')) ? 'ring-2 ring-brand-500' : 'hover:shadow-md'}`}>
                                    <div className="relative cursor-pointer" onClick={() => handleSelectProject(p)}>
                                        <div className={`h-1.5 w-full ${getStatusBannerColor(p.projectStatus)}`}></div>
                                        <div className="p-3">
                                            <div className="flex justify-between items-start mb-2"><div className="flex-1 min-w-0"><h3 className="text-sm font-bold text-slate-900 leading-tight mb-1 truncate">{p.name}</h3><span className={`inline-block text-[10px] px-1.5 py-0.5 rounded text-white font-medium ${getStatusBannerColor(p.projectStatus)}`}>{p.projectStatus || '未設定'}</span></div></div>
                                            <div className="flex justify-between items-end text-[10px] text-slate-500 font-mono"><div>{p.pwbs}{p.sakuban ? `-${p.sakuban}` : ''}</div><div className="font-bold text-slate-700">{formatProgress(p.wbsProgress)}</div></div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    );
                }
            };

            return (
                <div className="flex h-screen bg-slate-50 font-sans text-slate-600 overflow-hidden relative">
                    <datalist id="member-options">{MEMBER_OPTIONS.map(opt => <option key={opt} value={opt} />)}</datalist>
                    <ToastContainer toasts={toasts} removeToast={removeToast} />
                    <div className="flex h-full transition-transform duration-500 ease-in-out" style={{ width: '200vw', transform: showSchedule ? 'translateX(-100vw)' : 'translateX(0)' }}>
                        <div className="w-screen h-full flex flex-col min-w-0 flex-shrink-0">
                            {activeWbsUrl ? (
                                <div className="flex h-full">
                                    <div className="w-[250px] bg-white border-r border-slate-200 flex flex-col animate-fade-in-left">
                                        <div className="p-4 border-b border-slate-200 bg-white z-10">
                                            <div className="flex items-center gap-2 mb-4"><div className="bg-brand-600 text-white p-1.5 rounded-lg"><BriefcaseIcon className="w-4 h-4" /></div><h1 className="text-sm font-bold text-slate-900 tracking-tight">作業一覧2026</h1></div>
                                            <button onClick={() => setActiveModal('project')} className="w-full inline-flex items-center justify-center px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 font-medium text-xs mb-3"><PlusIcon className="w-3 h-3 mr-2"/> 新規プロジェクト</button>
                                            <div className="flex justify-between items-center gap-2">
                                                <div className="flex space-x-1 bg-slate-100 p-1 rounded-lg flex-1">
                                                    <button onClick={() => setTab('active')} className={`flex-1 py-1.5 rounded text-xs font-medium ${tab === 'active' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500'}`}>進行中</button>
                                                    <button onClick={() => setTab('archive')} className={`flex-1 py-1.5 rounded text-xs font-medium ${tab === 'archive' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500'}`}>完了</button>
                                                </div>
                                                <button onClick={() => handleSyncWbs(false)} disabled={syncing} className={`p-1.5 rounded-lg border border-slate-200 ${syncing ? 'text-slate-400' : 'text-slate-600 hover:bg-slate-50'}`}><RefreshIcon className={`w-3.5 h-3.5 ${syncing ? 'animate-spin' : ''}`} /></button>
                                            </div>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-3 bg-slate-50">{renderProjectList(true)}</div>
                                    </div>
                                    <div className="flex-1 bg-slate-100 flex flex-col h-full relative animate-slide-in-right overflow-hidden">
                                        <div className="flex-1 w-full h-full p-4">
                                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 w-full h-full overflow-hidden flex flex-col">
                                                <div className="bg-slate-50 border-b border-slate-200 px-4 py-2 flex justify-between items-center">
                                                    <h2 className="text-xs font-bold text-slate-500 flex items-center"><FileTextIcon className="w-4 h-4 mr-2"/> WBS Preview</h2>
                                                    <div className="flex items-center gap-4">
                                                        <ActiveUserIndicator activeUsers={activeUsers} />
                                                        <a href={activeWbsUrl} target="_blank" rel="noopener noreferrer" className="text-xs text-brand-600 hover:text-brand-800 font-medium flex items-center">別タブ <ExternalLinkIcon className="w-3 h-3 ml-1"/></a>
                                                        <button onClick={() => setActiveWbsUrl(null)} className="text-slate-400 hover:text-slate-600 rounded p-1 transition"><XIcon className="w-5 h-5"/></button>
                                                    </div>
                                                </div>
                                                <div className="flex-1 w-full relative overflow-hidden bg-slate-50">
                                                    <iframe src={activeWbsUrl} className="border-none absolute top-0 left-0" style={{ width: '111.11%', height: '111.11%', transform: 'scale(0.9)', transformOrigin: 'top left' }} title="WBS Preview" allow="autoplay"></iframe>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="w-full flex flex-col h-full overflow-y-auto animate-fade-in-left">
                                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm px-4 sm:px-6 lg:px-8">
                                        <div className="flex justify-between h-16 items-center">
                                            <div className="flex items-center gap-3"><div className="bg-brand-600 text-white p-2 rounded-lg"><BriefcaseIcon className="w-5 h-5" /></div><h1 className="text-xl font-bold text-slate-900 tracking-tight">作業一覧2026</h1></div>
                                            <div className="flex items-center gap-4">
                                                <ActiveUserIndicator activeUsers={activeUsers} />
                                                <div className="flex space-x-1 bg-slate-100 p-1 rounded-lg">
                                                    <button onClick={() => setTab('active')} className={`px-4 py-1.5 rounded-md text-sm font-medium ${tab === 'active' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500'}`}>進行中</button>
                                                    <button onClick={() => setTab('archive')} className={`px-4 py-1.5 rounded-md text-sm font-medium ${tab === 'archive' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500'}`}>完了</button>
                                                </div>
                                                <button onClick={() => setActiveModal('project')} className="inline-flex items-center px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition shadow-sm font-medium text-sm"><PlusIcon className="w-4 h-4 mr-2"/> 新規プロジェクト</button>
                                                <button onClick={() => handleSyncWbs(false)} disabled={syncing} className={`flex items-center text-sm font-medium px-3 py-2 rounded-lg transition ${syncing ? 'text-slate-400' : 'text-brand-600 hover:bg-brand-50'}`}><RefreshIcon className={`w-4 h-4 mr-2 ${syncing ? 'animate-spin' : ''}`} />{syncing ? '' : ''}</button>
                                            </div>
                                        </div>
                                    </nav>
                                    <main className="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">{renderProjectList(false)}</main>
                                </div>
                            )}
                        </div>
                        <div className={`w-screen h-full flex-shrink-0 bg-white border-l border-slate-200 relative flex flex-col`}>
                            <SchedulePanel projects={projects} showSchedule={showSchedule} onOpenCreateModal={() => setActiveModal('trip')} onEditProject={openEditModal} onEditSchedule={handleEditSchedule} activeUsers={activeUsers} onArchiveProject={handleArchiveProject} onRestoreProject={handleRestoreProject} />
                        </div>
                        <div className="absolute top-1/2 -translate-y-1/2 z-50 transition-all duration-300" style={{ left: '100vw', transform: showSchedule ? 'translateX(0)' : 'translateX(-100%)' }}>
                            <button onClick={() => setShowSchedule(!showSchedule)} className={`bg-white border border-slate-200 shadow-md p-2 text-slate-500 hover:text-brand-600 flex items-center justify-center ${showSchedule ? 'rounded-r-lg border-l-0' : 'rounded-l-lg border-r-0'}`}>
                                {showSchedule ? <ChevronRightIcon className="w-5 h-5"/> : <ChevronLeftIcon className="w-5 h-5"/>}
                            </button>
                        </div>
                    </div>

                    {editingSchedule && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 animate-expand-fade-in">
                                <h3 className="text-lg font-bold text-slate-800 mb-4">期間設定</h3>
                                <form onSubmit={handleSaveScheduleUpdate}>
                                    <div className="mb-4">
                                        <div className="text-sm font-bold text-slate-700 mb-2">{editingSchedule.data.name}</div>
                                        <div className="text-xs text-slate-500 mb-4">{editingSchedule.project.name}</div>
                                        <div className="space-y-3">
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">開始日</label><input type="date" value={editingSchedule.data.startDate} onChange={e => setEditingSchedule({...editingSchedule, data: {...editingSchedule.data, startDate: e.target.value}})} className="w-full px-3 py-2 border rounded-lg outline-none" required/></div>
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">終了日</label><input type="date" value={editingSchedule.data.endDate} onChange={e => setEditingSchedule({...editingSchedule, data: {...editingSchedule.data, endDate: e.target.value}})} className="w-full px-3 py-2 border rounded-lg outline-none" required/></div>
                                        </div>
                                    </div>
                                    <div className="flex gap-3 pt-2">
                                        <button type="button" onClick={() => setEditingSchedule(null)} className="flex-1 px-4 py-2 border rounded-lg text-sm font-bold text-slate-500">キャンセル</button>
                                        <button type="submit" className="flex-1 px-4 py-2 bg-brand-600 text-white rounded-lg font-bold text-sm">保存</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {activeModal && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
                                <h2 className="text-xl font-bold mb-4">{activeModal === 'project' ? '新規プロジェクト作成' : '新規出張予定登録'}</h2>
                                
                                {/* ★スマートペースト機能の復元 */}
                                {activeModal === 'project' && (
                                    <>
                                        <div className="mb-4">
                                            <label className="block text-xs font-bold text-brand-600 uppercase mb-2">Excelから貼り付け (スマートペースト)</label>
                                            <textarea className="w-full h-20 px-3 py-2 border border-brand-200 bg-brand-50 rounded-lg text-xs font-mono focus:ring-2 focus:ring-brand-500 outline-none" placeholder={`行をコピーして貼り付け...\n例: 見積No | 内容 | 物件 | (無視) | PWBS | 作番 | PJ | 納期`} onChange={handleSmartPaste}></textarea>
                                        </div>
                                        <div className="border-t border-slate-100 my-4"></div>
                                    </>
                                )}

                                <form onSubmit={handleCreateProject}>
                                    <div className="space-y-4">
                                        <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">プロジェクト名</label><input name="name" value={projectForm.name} onChange={(e) => setProjectForm({...projectForm, name: e.target.value})} required className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                        <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">物件</label><input name="siteName" value={projectForm.siteName} onChange={(e) => setProjectForm({...projectForm, siteName: e.target.value})} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                        {activeModal === 'project' ? (
                                            <>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">PJコード</label><input name="code" value={projectForm.code} onChange={(e) => setProjectForm({...projectForm, code: e.target.value})} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">納期</label><input type="date" name="deadline" value={projectForm.deadline} onChange={(e) => setProjectForm({...projectForm, deadline: e.target.value})} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">見積依頼No</label><input name="estimateNo" value={projectForm.estimateNo} onChange={(e) => setProjectForm({...projectForm, estimateNo: e.target.value})} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">PWBS</label><input name="pwbs" value={projectForm.pwbs} onChange={(e) => setProjectForm({...projectForm, pwbs: e.target.value})} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                                </div>
                                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">作番</label><input name="sakuban" value={projectForm.sakuban} onChange={(e) => setProjectForm({...projectForm, sakuban: e.target.value})} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                            </>
                                        ) : (
                                            <>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">見積No</label><input name="estimateNo" value={projectForm.estimateNo} onChange={(e) => setProjectForm({...projectForm, estimateNo: e.target.value})} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                                    <div className="flex gap-2">
                                                        <div className="w-28"><label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">PWBS</label><input name="pwbs" value={projectForm.pwbs} onChange={(e) => setProjectForm({...projectForm, pwbs: e.target.value})} className="w-full px-2 py-1.5 border rounded text-sm outline-none"/></div>
                                                        <div className="w-28"><label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">作番</label><input name="sakuban" value={projectForm.sakuban} onChange={(e) => setProjectForm({...projectForm, sakuban: e.target.value})} className="w-full px-2 py-1.5 border rounded text-sm outline-none"/></div>
                                                    </div>
                                                </div>
                                                <div className="bg-brand-50 p-4 rounded-xl border border-brand-100 mt-2">
                                                    <div className="flex justify-between items-center mb-4"><div className="flex items-center"><UserIcon className="w-4 h-4 text-brand-500 mr-2"/><label className="text-sm font-bold text-brand-700">参加メンバー</label></div><button type="button" onClick={() => addMemberToForm(setProjectForm, projectForm)} className="text-xs bg-white border border-brand-200 text-brand-600 px-3 py-1.5 rounded-full hover:bg-brand-50 font-bold flex items-center shadow-sm"><PlusIcon className="w-3 h-3 mr-1"/> 追加</button></div>
                                                    <div className="space-y-3">
                                                        {(projectForm.memberSchedules || []).map((m, idx) => (
                                                            <div key={idx} className="flex gap-2 items-center bg-white p-3 rounded-lg border border-brand-100 shadow-sm animate-expand-fade-in">
                                                                <div className="flex-shrink-0 w-32"><label className="block text-[10px] font-bold text-slate-400 mb-1">名前</label><input list="member-options" value={m.name} onChange={(e) => updateMemberInForm(setProjectForm, projectForm, idx, 'name', e.target.value)} className="w-full px-2 py-1.5 border border-slate-200 rounded text-sm outline-none"/></div>
                                                                <div className="flex-1 grid grid-cols-2 gap-2">
                                                                    <div><label className="block text-[10px] font-bold text-slate-400 mb-1">開始</label><input type="date" value={m.startDate} onChange={(e) => updateMemberInForm(setProjectForm, projectForm, idx, 'startDate', e.target.value)} className="w-full px-2 py-1.5 border border-slate-200 rounded text-sm outline-none"/></div>
                                                                    <div><label className="block text-[10px] font-bold text-slate-400 mb-1">終了</label><input type="date" value={m.endDate} onChange={(e) => updateMemberInForm(setProjectForm, projectForm, idx, 'endDate', e.target.value)} className="w-full px-2 py-1.5 border border-slate-200 rounded text-sm outline-none"/></div>
                                                                </div>
                                                                <button type="button" onClick={() => removeMemberFromForm(setProjectForm, projectForm, idx)} className="text-slate-300 hover:text-red-500 p-1 rounded mt-4"><XIcon className="w-4 h-4"/></button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                        {activeModal === 'project' && (<div className="flex items-center pt-2"><input type="checkbox" id="skipWbs" checked={projectForm.skipWbs} onChange={(e) => setProjectForm({...projectForm, skipWbs: e.target.checked})} className="w-4 h-4 text-brand-600 rounded"/><label htmlFor="skipWbs" className="ml-2 text-xs font-bold text-slate-500 uppercase">WBS作成不要</label></div>)}
                                    </div>
                                    <div className="flex gap-3 mt-6">
                                        <button type="button" onClick={() => setActiveModal(null)} className="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">キャンセル</button>
                                        <button type="submit" disabled={loading} className="flex-1 px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50">{loading ? '作成中...' : '作成'}</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                    
                    {editingProject && editForm && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
                                <h2 className="text-xl font-bold mb-4">{editingProject.type === 'trip' ? 'プロジェクト情報' : 'プロジェクト詳細編集'}</h2>
                                <form onSubmit={handleSaveSettings}>
                                    <div className="space-y-4">
                                        <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">プロジェクト名</label><input name="name" defaultValue={editForm.name} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">物件</label><input name="siteName" defaultValue={editForm.siteName} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                            {editingProject.type !== 'trip' && <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">PJコード</label><input name="code" defaultValue={editForm.code} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>}
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">見積依頼No</label><input name="estimateNo" defaultValue={editForm.estimateNo} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                            {/* ★納期修正: defaultValue に日付フォーマット変換を適用 */}
                                            {editingProject.type !== 'trip' && <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">納期</label><input type="date" name="deadline" defaultValue={formatDateForInput(editForm.deadline)} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>}
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">PWBS</label><input name="pwbs" defaultValue={editForm.pwbs} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">作番</label><input name="sakuban" defaultValue={editForm.sakuban} className="w-full px-3 py-2 border rounded-lg outline-none"/></div>
                                        </div>
                                        {(editingProject.type === 'trip' || editForm.startDate) && (
                                            <div className="bg-brand-50 p-3 rounded-lg border border-brand-100">
                                                <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-brand-600 uppercase">メンバー & 日程</label><button type="button" onClick={() => addMemberToForm(setEditForm, editForm)} className="text-[10px] bg-white border border-brand-200 text-brand-600 px-2 py-1 rounded hover:bg-brand-100">＋ 追加</button></div>
                                                <div className="space-y-3">
                                                    {(editForm.memberSchedules || []).map((m, idx) => (
                                                        <div key={idx} className="flex gap-2 bg-white p-3 rounded-lg border border-brand-100 shadow-sm animate-expand-fade-in group hover:border-brand-200 transition">
                                                            <div className="flex-shrink-0 w-32"><label className="block text-[10px] font-bold text-slate-400 mb-1">名前</label><input list="member-options" value={m.name} onChange={(e) => updateMemberInForm(setEditForm, editForm, idx, 'name', e.target.value)} className="w-full px-2 py-1.5 border border-slate-200 rounded text-sm outline-none"/></div>
                                                            <div className="flex-1 grid grid-cols-2 gap-2">
                                                                <div><label className="block text-[10px] font-bold text-slate-400 mb-1">開始</label><input type="date" value={m.startDate} onChange={(e) => updateMemberInForm(setEditForm, editForm, idx, 'startDate', e.target.value)} className="w-full px-2 py-1.5 border border-slate-200 rounded text-sm outline-none"/></div>
                                                                <div><label className="block text-[10px] font-bold text-slate-400 mb-1">終了</label><input type="date" value={m.endDate} onChange={(e) => updateMemberInForm(setEditForm, editForm, idx, 'endDate', e.target.value)} className="w-full px-2 py-1.5 border border-slate-200 rounded text-sm outline-none"/></div>
                                                            </div>
                                                            <button type="button" onClick={() => removeMemberFromForm(setEditForm, editForm, idx)} className="text-slate-300 hover:text-red-500 p-1 rounded mt-4"><XIcon className="w-4 h-4"/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        {editingProject.type !== 'trip' && (<div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">WBS URL</label><input name="wbsUrl" defaultValue={editForm.wbsUrl} className="w-full px-3 py-2 border rounded-lg outline-none" placeholder="https://..."/></div>)}
                                    </div>
                                    <div className="flex gap-3 mt-6">
                                        <button type="button" onClick={() => { setEditingProject(null); setEditForm(null); }} className="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50">キャンセル</button>
                                        <button type="button" onClick={() => handleDeleteProject(editingProject.id)} className="flex-1 px-4 py-2 bg-red-50 text-red-600 border border-red-100 rounded-lg hover:bg-red-100 font-bold">削除</button>
                                        {/* ★指示に基づき、全ての編集モーダルから完了（アーカイブ）ボタンを削除 */}
                                        <button type="submit" className="flex-1 px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 font-bold shadow-sm">保存</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>